# Copilot Instructions — yasu-widget-v1

## 0. 前提（Source of Truth）

本プロジェクトの仕様（要求事項）は以下のドキュメントが唯一の正です。

- docs/01_requirements_ears.md
- docs/06_verification.md

ここ（copilot-instructions.md）には仕様は書きません。
仕様の再定義・拡張・省略は行わないでください。

不明点がある場合は推測せず、質問してください。

---

## 1. 基本方針

### 1.1 責務分離を徹底すること
- ドメインロジック（モード判定・方向判定・次便抽出）は純粋なKotlinコードに分離する
- Widget描画コードに業務ロジックを書かない
- 位置取得・スケジューリング・JSONパースはUIと分離する

### 1.2 テスト可能性を最優先すること
- モード判定ロジックはAndroid依存を持たない
- 現在時刻は直接取得せず、ClockやTimeProviderを介す
- 純粋関数としてユニットテスト可能な構造にする

### 1.3 暗黙状態を持たない
- グローバル状態を持たない
- 副作用は明示的に管理する
- すべての表示は単一の「UI状態モデル」から生成する

---

## 2. Widget実装ポリシー

- Android Widgetは「スワイプ前提」で設計しない
- 操作はクリック（ボタン・タップ）で実装する
- 表示更新は必ず冪等にする（何度呼んでも同じ結果）
- UI描画はイミュータブルな状態モデルを入力として行う

---

## 3. 更新・スケジューリング方針

- 常駐ループや無限ポーリングは禁止
- 更新は自己再スケジュール型（Alarm等）で実装する
- exact alarmが保証されない前提で設計する
- 手動更新手段は必ず提供する
- 毎分更新は「保証」ではなく「試行」として扱う

---

## 4. エラーハンドリング方針

- Widgetは絶対にクラッシュさせない
- 例外は必ず捕捉する
- 失敗時はキャッシュ表示にフォールバックする
- ログは開発者向け、UI表示はユーザー向けに分離する

---

## 5. JSON取り扱い方針

- JSON構造は厳密にバリデーションする
- 必須キーが欠けている場合は明示的にエラー扱いにする
- 不正データを黙って無視しない
- パース処理はドメインロジックから分離する

---

## 6. 状態管理

永続化する情報は最小限にする：

- 最終更新時刻
- 最終表示状態
- 固定駅
- 一時選択駅とその有効期限

Locationオブジェクトはそのまま保存しない。

---

## 7. コードスタイル

- Kotlinらしい記述を優先する
- data classを活用する
- sealed classで表示モードを表現する
- ネストの深いif文を避ける
- コメントよりも意味のある命名を優先する

---

## 8. パフォーマンス方針

- 更新処理は50ms以内を目安に設計する
- JSONの再パースは必要なときのみ行う
- メインスレッドをブロックしない

---

## 9. スコープ逸脱の禁止

仕様に書かれていない機能は実装しない。

例：
- リアルタイム遅延取得
- 祝日カレンダー
- Webスクレイピング
- 全国対応拡張

---

## 10. 判断に迷った場合

- 単純な設計を選ぶ
- 明示的な実装を選ぶ
- 推測せず質問する
